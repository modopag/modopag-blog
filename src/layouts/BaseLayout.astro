---
import { ViewTransitions } from 'astro:transitions';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import CTABannerBottom from '@/components/CTABannerBottom.astro';
import NavigationLoader from '@/components/NavigationLoader.astro';
import CookieConsentBanner from '@/components/CookieConsentBanner';
import WhatsAppLeadCapture from '@/components/WhatsAppLeadCapture';
import ExitModal from '@/components/ExitModal.astro';
import { BRAND, SITE } from '@/lib/images';
import '@/styles/global.css';

interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;

// Schema.org data
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "modoPAG",
  "url": SITE.url,
  "logo": {
    "@type": "ImageObject",
    "url": BRAND.ogDefault,
    "width": 1000,
    "height": 1000
  },
  "image": BRAND.ogDefault,
  "description": "A forma mais simples de aceitar pagamentos no seu neg√≥cio. Maquininhas com as menores taxas do Brasil.",
  "sameAs": [
    "https://instagram.com/modopag",
    "https://linkedin.com/company/modopag",
    "https://x.com/modopag"
  ]
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE.name,
  "alternateName": "Blog modoPAG",
  "description": SITE.description,
  "url": SITE.blogUrl,
  "inLanguage": SITE.language,
  "publisher": {
    "@type": "Organization",
    "name": "modoPAG",
    "logo": {
      "@type": "ImageObject",
      "url": BRAND.ogDefault
    }
  }
};
---

<!doctype html>
<html lang={SITE.language}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/avif" href={BRAND.favicon} />
    <link rel="icon" type="image/png" sizes="32x32" href={BRAND.icon} />
    <link rel="icon" type="image/png" sizes="192x192" href={BRAND.iconLarge} />
    <link rel="apple-touch-icon" sizes="180x180" href={BRAND.iconLarge} />

    <!-- Theme color for browser UI -->
    <meta name="theme-color" content={SITE.secondaryColor} />

    <!-- DNS Prefetch and Preconnect for external resources -->
    <!-- Supabase (database + storage) -->
    <link rel="dns-prefetch" href="https://acxelejbtjjkttfwrdbi.supabase.co" />
    <link rel="preconnect" href="https://acxelejbtjjkttfwrdbi.supabase.co" crossorigin />

    <!-- modoPAG Tracker -->
    <link rel="dns-prefetch" href="https://pagamento.modopag.com.br" />
    <link rel="preconnect" href="https://pagamento.modopag.com.br" />

    <!-- LOCAL FONTS - Preload for faster rendering -->
    <link rel="preload" href="/fonts/inter-latin-400.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/inter-latin-600.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Local Font Definitions -->
    <style is:inline>
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: url('/fonts/inter-latin-400.woff2') format('woff2');
      }
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 500;
        font-display: swap;
        src: url('/fonts/inter-latin-500.woff2') format('woff2');
      }
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 600;
        font-display: swap;
        src: url('/fonts/inter-latin-600.woff2') format('woff2');
      }
      @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: url('/fonts/inter-latin-700.woff2') format('woff2');
      }
    </style>

    <!-- Schema.org - Organization -->
    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />

    <!-- Schema.org - WebSite -->
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    <!-- View Transitions for smooth page navigation -->
    <ViewTransitions />

    <slot name="head" />
  </head>
  <body class="min-h-screen flex flex-col bg-white text-secondary-500 font-sans">
    <NavigationLoader />
    <Header />
    <main class:list={['flex-1', className]}>
      <slot />
    </main>
    <CTABannerBottom />
    <Footer />

    <!-- Cookie Consent Banner (LGPD) - deve vir antes do WhatsApp -->
    <CookieConsentBanner client:load />

    <!-- WhatsApp Lead Capture -->
    <WhatsAppLeadCapture client:load />

    <!-- Instant navigation on mousedown for faster perceived performance -->
    <script>
      function initInstantClick() {
        document.addEventListener('mousedown', (e) => {
          const link = (e.target as HTMLElement).closest('a[href]') as HTMLAnchorElement;
          if (!link) return;

          const href = link.getAttribute('href');
          if (!href || href.startsWith('#') || href.startsWith('http') || link.hasAttribute('data-no-instant')) return;

          // Navigate on mousedown instead of click for ~100ms faster response
          e.preventDefault();
          window.location.href = href;
        }, { capture: true });
      }

      initInstantClick();
    </script>

    <!-- Exit Modal para links externos -->
    <ExitModal />

    <!-- modoPAG Tracker - Non-blocking load at end of body -->
    <script is:inline src="https://pagamento.modopag.com.br/tracking/modopag-tracker.js" defer></script>
    <script is:inline src="https://pagamento.modopag.com.br/tracking/modopag-framer-init.js" defer></script>

  </body>
</html>
