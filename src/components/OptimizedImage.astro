---
/**
 * OptimizedImage.astro
 * Componente de imagem otimizada com:
 * - Aspect ratio preservado (evita CLS)
 * - Lazy/eager loading configuravel
 * - Background placeholder enquanto carrega
 * - Suporte a diferentes tamanhos responsivos
 *
 * Uso:
 * <OptimizedImage
 *   src={post.featured_image}
 *   alt={post.title}
 *   width={1200}
 *   height={630}
 *   priority={true}
 * />
 */

interface Props {
  src: string;
  alt: string;
  width: number;
  height: number;
  class?: string;
  wrapperClass?: string;
  priority?: boolean; // true = eager loading (LCP image)
  sizes?: string;
  rounded?: boolean;
}

const {
  src,
  alt,
  width,
  height,
  class: className = '',
  wrapperClass = '',
  priority = false,
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px',
  rounded = false,
} = Astro.props;

// Calcular aspect ratio para CSS (evita CLS)
const aspectRatio = `${width} / ${height}`;
---

<div
  class:list={['optimized-image-wrapper', wrapperClass, { 'rounded-2xl': rounded }]}
  style={`aspect-ratio: ${aspectRatio};`}
>
  <img
    src={src}
    alt={alt}
    width={width}
    height={height}
    sizes={sizes}
    loading={priority ? 'eager' : 'lazy'}
    decoding={priority ? 'sync' : 'async'}
    fetchpriority={priority ? 'high' : 'auto'}
    class:list={['optimized-image', className, { 'rounded-2xl': rounded }]}
  />
</div>

<style>
  .optimized-image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    background-color: #f3f4f6; /* bg-gray-100 */
  }

  .optimized-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Dark mode placeholder */
  :global(.dark) .optimized-image-wrapper {
    background-color: #374151; /* bg-gray-700 */
  }
</style>
