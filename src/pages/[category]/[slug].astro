---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SEOHead from '@/components/SEOHead.astro';
import SchemaOrg from '@/components/SchemaOrg.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import TableOfContentsSidebar from '@/components/TableOfContentsSidebar.astro';
import CalculatorEmbed from '@/components/CalculatorEmbed.astro';
import FAQAccordion from '@/components/FAQAccordion';
import AuthorSection from '@/components/AuthorSection.astro';
import CTABox from '@/components/CTABox.astro';
import ShareButtons from '@/components/ShareButtons.astro';
import RelatedPosts from '@/components/RelatedPosts.astro';
import ReadingProgress from '@/components/ReadingProgress.astro';
import BackToTop from '@/components/BackToTop.astro';
import {
  getPostBySlug,
  getFaqsByPostId,
  getRelatedPosts,
  incrementViews,
  getCommentsByPostId,
  getCommentCount,
} from '@/lib/database';
import CommentSection from '@/components/CommentSection.astro';
import {
  generateArticleSchema,
  generateFAQSchema,
  generateBreadcrumbSchema,
  generatePersonSchema,
} from '@/utils/seo';
import {
  extractTableOfContents,
  addHeadingIds,
  formatDateShort,
  calculateReadingTime,
  getTypeLabel,
  getTypeColor,
  isDifferentDay,
  splitContentAfterIntro,
} from '@/utils/helpers';
import { parseMarkdown } from '@/lib/markdown';

const { category: categorySlug, slug } = Astro.params;

if (!categorySlug || !slug) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

const post = await getPostBySlug(categorySlug, slug);

if (!post) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found',
  });
}

// Fire and forget view increment
incrementViews(post.id);

const faqs = await getFaqsByPostId(post.id);
const relatedPosts = await getRelatedPosts(post.category_id, post.id, 3);
const comments = await getCommentsByPostId(post.id);
const commentCount = await getCommentCount(post.id);

// Process content: parse markdown to HTML, then add heading IDs
const htmlContent = await parseMarkdown(post.content);
const contentWithIds = addHeadingIds(htmlContent);
const toc = extractTableOfContents(contentWithIds);
const readingTime = post.reading_time || calculateReadingTime(post.content);

// Calculator setup
const showCalculator = post.calculator_enabled && post.calculator_code;
const calculatorPosition = post.calculator_position || 'bottom';

// Hide hero image for calculator posts or "calculadoras" category
const isCalculatorPost = post.calculator_enabled === true;
const isCalculatorCategory = categorySlug === 'calculadoras';
const shouldHideHeroImage = isCalculatorPost || isCalculatorCategory;

// Split content for "middle" position calculator
let introContent = '';
let remainingContent = '';
if (showCalculator && calculatorPosition === 'middle') {
  const split = splitContentAfterIntro(contentWithIds);
  introContent = split.intro;
  remainingContent = split.remaining;
}

// Check if post was updated after creation
const wasUpdated = isDifferentDay(post.created_at, post.updated_at);

// Author info (default for now, can be extended to support per-post authors)
const author = {
  name: 'Equipe modoPAG',
  bio: 'Especialistas em pagamentos e soluções financeiras para empreendedores brasileiros.',
};

// Schema.org
const siteUrl = 'https://modopag.com.br';
const postUrl = `${siteUrl}/blog/${categorySlug}/${slug}/`;
const articleSchema = generateArticleSchema(post, categorySlug, author);
const faqSchema = faqs.length > 0 ? generateFAQSchema(faqs) : '';
const personSchema = generatePersonSchema(author);
const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Blog', url: `${siteUrl}/blog/` },
  { name: post.category?.name || 'Artigos', url: `${siteUrl}/blog/${categorySlug}/` },
  { name: post.title, url: postUrl },
]);

const schemas = [articleSchema, breadcrumbSchema, personSchema, faqSchema].filter(Boolean);

const breadcrumbItems = [
  { label: post.category?.name || 'Artigos', href: `/blog/${categorySlug}/` },
  { label: post.title },
];
---

<BaseLayout>
  <SEOHead
    slot="head"
    title={post.meta_title || post.title}
    description={post.meta_description || post.description || ''}
    canonical={postUrl}
    ogImage={post.featured_image || undefined}
    ogType="article"
    publishedTime={post.created_at}
    modifiedTime={post.updated_at}
    author={author.name}
    section={post.category?.name}
  />
  <SchemaOrg slot="head" schema={schemas} />

  <!-- Reading Progress Bar -->
  <ReadingProgress />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbItems} />

    <!-- Article Header -->
    <header class="mb-8">
      <!-- Category Tag -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        {post.category && (
          <a
            href={`/blog/${categorySlug}/`}
            class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium transition-colors hover:opacity-80"
            style={`background-color: ${post.category.color}20; color: ${post.category.color};`}
          >
            {post.category.emoji && <span>{post.category.emoji}</span>}
            {post.category.name}
          </a>
        )}
        <span class:list={['px-3 py-1 rounded-full text-sm font-medium', getTypeColor(post.type)]}>
          {getTypeLabel(post.type)}
        </span>
      </div>

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-secondary-500 mb-4 text-balance leading-tight">
        {post.title}
      </h1>

      <!-- Description -->
      {post.description && (
        <p class="text-lg text-secondary-400 mb-6 leading-relaxed">
          {post.description}
        </p>
      )}

      <!-- Meta Info -->
      <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-secondary-400">
        <!-- Author -->
        <div class="flex items-center gap-2">
          <div class="w-6 h-6 rounded-full bg-primary-500 flex items-center justify-center">
            <span class="text-xs font-bold text-secondary-500">EM</span>
          </div>
          <span class="font-medium text-secondary-500">{author.name}</span>
        </div>

        <span class="text-secondary-300">•</span>

        <!-- Published Date -->
        <time datetime={post.created_at}>
          Publicado em {formatDateShort(post.created_at)}
        </time>

        <!-- Updated Date (if different) -->
        {wasUpdated && (
          <>
            <span class="text-secondary-300">•</span>
            <time datetime={post.updated_at} class="text-primary-600">
              Atualizado em {formatDateShort(post.updated_at)}
            </time>
          </>
        )}

        <span class="text-secondary-300">•</span>

        <!-- Reading Time -->
        <span>{readingTime} min de leitura</span>

        <span class="text-secondary-300">•</span>

        <!-- Comment Count -->
        <a href="#comments" class="hover:text-primary-600 transition-colors">
          {commentCount === 0 ? 'Comentar' : `${commentCount} ${commentCount === 1 ? 'comentário' : 'comentários'}`}
        </a>
      </div>
    </header>

    <!-- Table of Contents (Collapsible) -->
    <TableOfContentsSidebar items={toc} />

    <!-- Featured Image (hidden for calculator posts and calculadoras category) -->
    {!shouldHideHeroImage && post.featured_image && (
      <figure class="mb-8 -mx-4 sm:mx-0">
        <img
          src={post.featured_image}
          alt={post.featured_image_alt || post.title}
          class="w-full sm:rounded-2xl"
          loading="eager"
          decoding="async"
          fetchpriority="high"
        />
      </figure>
    )}

    <!-- Calculator: TOP position -->
    {showCalculator && calculatorPosition === 'top' && post.calculator_code && (
      <CalculatorEmbed
        title={post.calculator_title}
        description={post.calculator_description}
        code={post.calculator_code}
      />
    )}

    <!-- Article Content -->
    {showCalculator && calculatorPosition === 'middle' ? (
      <>
        {/* Intro content */}
        <div
          class="prose prose-lg max-w-none prose-headings:scroll-mt-20"
          set:html={introContent}
        />

        {/* Calculator: MIDDLE position */}
        {post.calculator_code && (
          <CalculatorEmbed
            title={post.calculator_title}
            description={post.calculator_description}
            code={post.calculator_code}
          />
        )}

        {/* Remaining content */}
        <div
          class="prose prose-lg max-w-none prose-headings:scroll-mt-20"
          set:html={remainingContent}
        />
      </>
    ) : (
      <div
        class="prose prose-lg max-w-none prose-headings:scroll-mt-20"
        set:html={contentWithIds}
      />
    )}

    <!-- Calculator: BOTTOM position -->
    {showCalculator && calculatorPosition === 'bottom' && post.calculator_code && (
      <CalculatorEmbed
        title={post.calculator_title}
        description={post.calculator_description}
        code={post.calculator_code}
      />
    )}

    <!-- FAQ Section -->
    {faqs.length > 0 && <FAQAccordion client:visible faqs={faqs} />}

    <!-- Author Section -->
    <AuthorSection
      name={author.name}
      bio={author.bio}
    />

    <!-- Share Buttons -->
    <div class="my-8 pt-8 border-t border-secondary-200">
      <ShareButtons url={postUrl} title={post.title} />
    </div>

    <!-- Related Posts -->
    <RelatedPosts posts={relatedPosts} />

    <!-- CTA Box -->
    <CTABox />

    <!-- Comment Section -->
    <CommentSection postId={post.id} comments={comments} commentCount={commentCount} />
  </article>

  <!-- Back to Top Button -->
  <BackToTop />
</BaseLayout>

<style>
  /* Smooth scroll for anchor links */
  :global(html) {
    scroll-behavior: smooth;
  }
</style>
